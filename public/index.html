<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.7.0/dist/alpine.min.js" defer></script>
    <!-- <script src="script.js" defer></script> -->
    <meta charset="UTF-8">
    <title>Subir archivo</title>
</head>
<body>
    <div class="formulario" x-data="form()">
        <input id="uploadInput" type="file" accept=".txt, .csv">
        <br>
        <button id="uplaoad" type="button" @click="upload">Subir<br>
        <button id="download" type="button" @click="download">Descargar<br>
    </div>

    <script>
        function form() {
            return {
                async upload() {
                    const input = document.getElementById("uploadInput");
                    const file = input.files[0];
                    if (!file) {
                        return alert("Debes seleccionar un archivo")
                    }

                    const formData = new FormData();
                    formData.append("file", file, file.name)
                    formData.append("filename", file.name)

                    const { result } = await fetch("http://localhost:5000/api/upload", {
                        method: "POST",
                        data: {
                            id: 1,
                            formData
                        }
                    });
                },
                async download() {
                    const request = await fetch("http://localhost:5000/api/download");
                    const { response } = await request.json();

                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += this.getHeader(response[0]);
                    
                    /* get content */
                    csvContent += response.map(this.object2Line, this).join("");
                    
                    const uri = encodeURI(csvContent);

                    const link = document.createElement("a");
                    link.setAttribute("href", uri);
                    link.setAttribute("download", "MINERDd.csv");
                    document.body.appendChild(link);

                    link.click();
                },
                isLastProperty(prop, arr) {
                    return prop === arr[arr.length - 1]
                },
                object2Line(obj) {
                    let text = "";
                    const keys = Object.keys(obj);

                    for (const key of keys) {
                        text += this.isLastProperty(key, keys)
                            ? obj[key] + "\n"
                            : obj[key] + ",";

                    }
                    console.log(text)

                    return text
                },
                getHeader(obj) {
                    let text = "";
                    const keys = Object.keys(obj);

                    const toSentence = (txt) => {
                        return txt.replace(/([A-Z])/g, " $1");
                    }

                    for (const key of keys) {
                        text += this.isLastProperty(key, keys)
                            ? toSentence(key).toUpperCase() + "\n"
                            : toSentence(key).toUpperCase() + ",";
                    }

                    return text
                }
            }
        }
    </script>
</body>
</html>