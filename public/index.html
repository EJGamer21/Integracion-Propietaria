<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.7.0/dist/alpine.min.js" defer></script>
    <meta charset="UTF-8">
    <title>Subir archivo</title>
</head>
<body>
    <div class="formulario" x-data="form()">
        <div>
            <span>Subir csv o txt</span>
            <input id="uploadCsv" type="file" accept=".txt, .csv">
        </div>
        
        <div>
            <span>Subir xml o txt</span>
            <input id="uploadXml" type="file" accept=".txt, .xml">
        </div>
        <br>
        <br>

        <button class="green-button" type="button" @click="upload">Subir</button>
        <br>
        <br>
        <button class="red-button" type="button" @click="download">Descargar</button>
        <br>
        <br>
        <button class="green-button" type="button" @click="import_xml">Importar a XML</button>
        <br>
        <br>
        <button class="red-button" type="button" @click="export_xml">Exportar a XML</button>
        <br>
        <br>
    </div>

    <script>
        function form() {
            return {
                async upload() {
                    const input = document.getElementById("uploadCsv");
                    const file = input.files[0];
                    if (!file) {
                        return alert("Debes seleccionar un archivo")
                    }

                    const formData = new FormData();
                    formData.append("file", file, file.name)

                    const { result } = await fetch("http://localhost:5000/api/upload", {
                        method: "POST",
                        body: formData
                    });
                },
                async download() {
                    const request = await fetch("http://localhost:5000/api/download");
                    const { header, data } = await request.json();

                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += this.getHeader(header);
                    csvContent += data;
                    
                    const uri = encodeURI(csvContent);

                    const link = document.createElement("a");
                    link.setAttribute("href", uri);
                    link.setAttribute("download", "MINERDd.csv");
                    document.body.appendChild(link);

                    link.click();
                },
                isLastProperty(property, array) {
                    return property === array[array.length - 1];
                },
                getHeader(source = "") {
                    let text = "";
                    const values = source.split(',');

                    const toSentence = (txt) => {
                        return txt.replace(/([A-Z])/g, " $1");
                    }

                    for (const value of values) {
                        text += this.isLastProperty(value, values)
                            ? toSentence(value).toUpperCase() + "\n"
                            : toSentence(value).toUpperCase() + ",";
                    }

                    return text
                },
                async export_xml() {
                    const request = await fetch("http://localhost:5000/api/export");
                    const file = await request.blob();
                    
                    const url = window.URL.createObjectURL(file);
                    const link = document.createElement("a");

                    link.setAttribute("href", url);
                    link.setAttribute("download", "export.xml");
                    document.body.appendChild(link);

                    link.click();
                },
                async import_xml() {
                    const input = document.getElementById("uploadXml");
                    const file = input.files[0];
                    if (!file) {
                        return alert("Debes seleccionar un archivo")
                    }

                    const formData = new FormData();
                    formData.append("file", file, file.name)

                    const { result } = await fetch("http://localhost:5000/api/import", {
                        method: "POST",
                        body: formData
                    });
                }
            }
        }
    </script>
</body>
</html>